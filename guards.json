[
  {
    "id": "overflow-dehydration",
    "description": "Order agent to dehydrate at overflow threshold (§CMD_DEHYDRATE is preloaded)",
    "trigger": {
      "type": "contextThreshold",
      "condition": { "gte": "OVERFLOW_THRESHOLD" }
    },
    "payload": {
      "text": "[block: overflow] §CMD_DEHYDRATE — context at threshold. Execute §CMD_DEHYDRATE protocol NOW.\n\nIf a session is active: pipe JSON to `engine session dehydrate sessions/[CURRENT_SESSION]`.\nIf no active session (completed/idle): pipe JSON with the NEXT skill intent to `engine session dehydrate sessions/[LAST_SESSION]`.\n\nThis is your LAST action before restart."
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 1,
    "inject": "always",
    "whitelist": [
      "Bash(engine session *)",
      "Bash(engine log *)",
      "Bash(ls *)"
    ]
  },
  {
    "id": "session-gate",
    "description": "Block non-whitelisted tools when no active session (§CMD_REQUIRE_ACTIVE_SESSION)",
    "trigger": {
      "type": "lifecycle",
      "condition": { "noActiveSession": true }
    },
    "payload": {
      "text": "[block: session] §CMD_REQUIRE_ACTIVE_SESSION — no active session (lifecycle: $lifecycle). Activate a session before proceeding. If the user already specified a skill or task, activate it directly via Skill tool or `engine session activate`. If unclear, use AskUserQuestion to ask. Popular: /do, /implement, /analyze, /fix, /test"
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 2,
    "inject": "always",
    "whitelist": [
      "AskUserQuestion",
      "Skill",
      "Bash(engine session *)",
      "Bash(engine session-search *)",
      "Bash(engine tag *)",
      "Bash(engine find-sessions *)",
      "Bash(engine doc-search *)",
      "Bash(engine discover-directives *)",
      "Read(*/.claude/*)",
      "Read(*/CLAUDE.md)",
      "Read(*/memory/*)",
      "Read(*/MEMORY.md)",
      "Read(*/sessions/*.md)",
      "Read(*/.state.json)"
    ]
  },
  {
    "id": "idle-gate",
    "description": "Restrict tools when session is idle — only skill selection and engine commands allowed",
    "trigger": {
      "type": "lifecycle",
      "condition": { "eq": "idle" }
    },
    "payload": {
      "text": "[block: idle] §CMD_REQUIRE_ACTIVE_SESSION — session idle. Select next skill or close. Use AskUserQuestion, Skill, or engine commands only."
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 3,
    "inject": "always",
    "whitelist": [
      "AskUserQuestion",
      "Skill",
      "Bash(engine session *)",
      "Bash(engine session-search *)",
      "Bash(engine tag *)",
      "Bash(engine find-sessions *)",
      "Bash(engine doc-search *)",
      "Bash(engine discover-directives *)",
      "Bash(engine log *)"
    ]
  },
  {
    "id": "read-throttle",
    "description": "Block Read tool when context usage is high to prevent context overflow from large file reads",
    "trigger": {
      "type": "contextThreshold",
      "condition": { "gte": 0.90 }
    },
    "toolFilter": { "include": ["Read"] },
    "payload": {
      "text": "[block: read-throttle] Context is at 90%+ capacity. Read tool is blocked to prevent context overflow.\n\nTo continue working:\n- Use Bash with `head`, `tail`, or `sed` for targeted line ranges\n- Use Grep to search for specific patterns instead of reading whole files\n- Use Glob to find files without reading them\n- Execute §CMD_DEHYDRATE to restart with a fresh context window\n\nDo NOT attempt to Read files — the context cannot absorb more content at this usage level."
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 4,
    "inject": "always",
    "whitelist": [
      "Bash(engine log *)",
      "Bash(engine session *)",
      "AskUserQuestion",
      "Skill"
    ]
  },
  {
    "id": "heartbeat-warn",
    "description": "Warn agent to log progress (§CMD_LOG_BETWEEN_TOOL_USES) at warn threshold",
    "trigger": {
      "type": "perTranscriptToolCount",
      "condition": { "eq": 3 }
    },
    "payload": {
      "text": "[warn: heartbeat] §CMD_APPEND_LOG"
    },
    "mode": "inline",
    "urgency": "allow",
    "priority": 50,
    "inject": "always",
    "whitelist": [
      "Bash(engine log *)",
      "Bash(engine session *)",
      "Read(*/.claude/*)",
      "Read(*/TEMPLATE_*_LOG.md)",
      "Task",
      "TaskOutput",
      "Write",
      "AskUserQuestion"
    ]
  },
  {
    "id": "heartbeat-block",
    "description": "Block agent until it logs progress (§CMD_LOG_BETWEEN_TOOL_USES) at block threshold",
    "trigger": {
      "type": "perTranscriptToolCount",
      "condition": { "gte": 10 }
    },
    "payload": {
      "text": "[warn: heartbeat] §CMD_APPEND_LOG"
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 5,
    "inject": "always",
    "whitelist": [
      "Bash(engine log *)",
      "Bash(engine session *)",
      "Read(*/.claude/*)",
      "Read(*/TEMPLATE_*_LOG.md)",
      "Task",
      "TaskOutput",
      "Write",
      "AskUserQuestion"
    ]
  },
  {
    "id": "preload",
    "description": "Auto-preload all pending files (directives, CMDs, templates) when discovered",
    "trigger": {
      "type": "discovery",
      "condition": { "field": "pendingPreloads", "nonEmpty": true }
    },
    "payload": {
      "preload": "$pendingPreloads"
    },
    "mode": "preload",
    "urgency": "allow",
    "priority": 20,
    "inject": "always"
  },
  {
    "id": "synthesis-commands",
    "description": "Inject synthesis protocol commands when entering synthesis phase",
    "trigger": {
      "type": "phase",
      "condition": { "matches": "Synthesis" }
    },
    "payload": {
      "text": "[warn: synthesis] §CMD_RUN_SYNTHESIS_PIPELINE — execute synthesis. Checklists → Debrief → Pipeline → Close. Each sub-phase requires proof before proceeding."
    },
    "mode": "inline",
    "urgency": "allow",
    "priority": 30,
    "inject": "once"
  }
]
