# Fleet tmux configuration (Powerline + Pane Titles)
# Requires: Nerd Font (brew install --cask font-meslo-lg-nerd-font)
# Load: fleet.sh uses this automatically via tmuxinator -p

# --- Prefix Key (Ctrl+b - standard) ---
set -g prefix C-b
bind C-b send-prefix

# --- Mouse Support ---
set -g mouse on

# --- Better Defaults ---
set -sg escape-time 10
set -g history-limit 50000
set -g display-time 4000
set -g status-interval 5
set -g focus-events on
# Both destroy-unattached and exit-unattached must be off — tmuxinator creates
# sessions detached (-d), then sets up windows/panes, then attaches. Either option
# kills the session/server before setup completes (no client attached yet).
# Instead, use a client-detached hook to kill the session when you close the window.
set -g destroy-unattached off
set -g exit-unattached off

# --- Prevent apps from overwriting pane titles ---
set -g allow-rename off
setw -g automatic-rename off
set -g set-titles off
set -g allow-passthrough off

# --- Numbering ---
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# --- Colors (Catppuccin Mocha) ---
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# --- Enable cmd+click for file paths (iTerm2) ---
set -ga terminal-features "*:hyperlinks"
set -g allow-passthrough on

# --- Status Bar (Top, Powerline) ---
set -g status-position top
set -g status-style 'bg=black fg=#cdd6f4'
set -g status-left-length 40
set -g status-right-length 40

# Left: session name
set -g status-left '#[fg=black,bg=#89b4fa,bold]  #S #[fg=#89b4fa,bg=black]'

# Right: time
set -g status-right '#[fg=#313244,bg=black]#[fg=#cdd6f4,bg=#313244] %H:%M #[fg=#89b4fa]#[fg=black,bg=#89b4fa,bold]  '

# Window tabs (background color notifications)
# Both selected and unselected use same style: bright text on dark tint (matches pane labels)
# Note: 4 nested conditionals = 4 closing braces }}}}
setw -g window-status-format '#{?#{==:#{@window_notify},error},#[fg=#f38ba8 bg=#3d2020],#{?#{==:#{@window_notify},unchecked},#[fg=#70e0a0 bg=#081a10],#{?#{==:#{@window_notify},working},#[fg=#5080b0 bg=#080c10],#{?#{==:#{@window_notify},checked},#[fg=#506850 bg=#0a1005],#[fg=#505050 bg=#0a0a0a]}}}} #I:#W #[default]'
setw -g window-status-current-format '#{?#{==:#{@window_notify},error},#[fg=#ffffff bg=#802020 bold],#{?#{==:#{@window_notify},unchecked},#[fg=#ffffff bg=#208050 bold],#{?#{==:#{@window_notify},working},#[fg=#ffffff bg=#204060 bold],#{?#{==:#{@window_notify},checked},#[fg=#ffffff bg=#304020 bold],#[fg=#ffffff bg=#303030 bold]}}}} #I:#W #[default]'
setw -g window-status-separator ' '

# --- Pane Backgrounds (static) ---
# Focused pane: black, Unfocused panes: very dark gray
set -g window-style 'bg=#0a0a0a'
set -g window-active-style 'bg=black'

# --- Pane Borders with Agent Titles ---
set -g pane-border-style 'fg=black'
set -g pane-active-border-style 'fg=black'
set -g pane-border-lines double
set -g pane-border-indicators colour

# Show pane titles in top border (the key feature!)
# Use @pane_label user option instead of pane_title (can't be overwritten by apps)
# Background colors: purple when coordinator is actively engaged, then notify state colors
# Priority: coordinator-active (dark purple) > notify state
set -g pane-border-status top
set -g pane-border-format '#{?#{==:#{@pane_coordinator_active},true},#[fg=#e0c0ff bg=#0d0518],#{?#{==:#{@pane_notify},error},#[fg=#f38ba8 bg=#3d2020],#{?#{==:#{@pane_notify},unchecked},#[fg=#70e0a0 bg=#081a10],#{?#{==:#{@pane_notify},working},#[fg=#5080b0 bg=#080c10],#{?#{==:#{@pane_notify},checked},#[fg=#506850 bg=#0a1005],#[fg=#505050 bg=#0a0a0a]}}}}} #{@pane_label} #[default]'

# --- Keybindings ---
# Reload config
bind r source-file ~/.claude/engine/skills/fleet/assets/tmux.conf \; display "Config reloaded"

# Quick kill session (Ctrl+b q) - hijacked from display-panes
bind q confirm-before -p "Kill fleet? (y/n)" kill-session

# Split panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Navigate panes with Alt+arrow (no prefix)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Navigate tabs with Shift+arrow (no prefix)
bind -n S-Left previous-window
bind -n S-Right next-window

# Resize panes with Ctrl+arrow (no prefix)
bind -n C-Left resize-pane -L 2
bind -n C-Right resize-pane -R 2
bind -n C-Up resize-pane -U 2
bind -n C-Down resize-pane -D 2

# Quick tab switching with Ctrl+number (no prefix)
# Note: Ctrl+number requires terminal to send escape sequences (iTerm2: Preferences → Keys → Presets → Natural Text Editing)
bind -n C-1 select-window -t 1
bind -n C-2 select-window -t 2
bind -n C-3 select-window -t 3
bind -n C-4 select-window -t 4
bind -n C-5 select-window -t 5
bind -n C-6 select-window -t 6
bind -n C-7 select-window -t 7
bind -n C-8 select-window -t 8
bind -n C-9 select-window -t 9

# Alt+number also works (fallback)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Zoom toggle
bind -n M-z resize-pane -Z

# Rename pane title (prefix + t)
bind t command-prompt -p "Pane title:" "select-pane -T '%%'"

# --- Copy Mode (vim-style) ---
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Escape send -X cancel

# Mouse scroll - enters copy mode with auto-exit (exits when you scroll to bottom)
# For alternate screen apps (vim, less): pass mouse events through
# For normal terminal: enter copy mode -e (auto-exit) and scroll
bind -T root WheelUpPane if-shell -F "#{alternate_on}" "send-keys -M" "copy-mode -e; send-keys -M"
bind -T root WheelDownPane if-shell -F "#{alternate_on}" "send-keys -M" "send-keys -M"

# Copy on mouse drag end (fixes direction inconsistency)
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# --- Fleet-specific ---
# Toggle coordinator summaries tab (swap managers into/out of summaries window)
bind S run-shell "~/.claude/scripts/fleet.sh summary toggle"

# Jump to delegation pool (last tab)
bind d select-window -t :$

# Clear notification state (after interrupt)
bind n run-shell "~/.claude/scripts/fleet.sh notify done"

# --- Notification System ---
# Pane border and window tab colors indicate agent state
# Focus hook for pane background tinting (focused=black, unfocused=status-tinted)
# Also transitions unchecked → checked when user focuses the pane
set-hook -g after-select-pane 'run-shell "~/.claude/hooks/pane-focus-style.sh; ~/.claude/scripts/fleet.sh notify-check #{pane_id}"'
set-hook -g after-select-window 'run-shell "~/.claude/hooks/pane-focus-style.sh; ~/.claude/scripts/fleet.sh notify-check #{pane_id}"'

# Initialize all panes with correct colors on config load (including purple layer)
# Uses fleet.sh style-init which runs _resolve_pane_color for each pane
run-shell '~/.claude/scripts/fleet.sh style-init'

# --- Cleanup on Detach ---
# Kill session when last client detaches (closing the terminal window).
# This replaces destroy-unattached/exit-unattached which break tmuxinator's setup.
set-hook -g client-detached 'kill-session'
