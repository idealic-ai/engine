{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CritiqueReport",
  "description": "Structured output from reviewer agent visual critique",
  "type": "object",
  "required": ["caseId", "timestamp", "overallScore", "summary", "pages", "issues"],
  "properties": {
    "caseId": {
      "type": "string",
      "description": "Case identifier"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of critique"
    },
    "overallScore": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "description": "Overall extraction quality score (0-100)"
    },
    "summary": {
      "type": "string",
      "description": "2-3 sentence executive summary of findings"
    },
    "pages": {
      "type": "array",
      "description": "Per-page critique results",
      "items": {
        "type": "object",
        "required": ["pageNumber", "score", "issues"],
        "properties": {
          "pageNumber": { "type": "integer" },
          "score": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100
          },
          "scopesDetected": { "type": "integer" },
          "tablesDetected": { "type": "integer" },
          "issues": {
            "type": "array",
            "items": { "$ref": "#/$defs/Issue" }
          },
          "observations": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Non-issue observations (things that look correct)"
          }
        }
      }
    },
    "issues": {
      "type": "array",
      "description": "Aggregated issues across all pages",
      "items": { "$ref": "#/$defs/Issue" }
    },
    "recommendations": {
      "type": "array",
      "description": "Actionable suggestions for fixing issues",
      "items": {
        "type": "object",
        "required": ["target", "action", "rationale", "priority"],
        "properties": {
          "target": {
            "type": "string",
            "enum": ["TABLE_PROMPT", "SCOPE_PROMPT", "SUMMARY_PROMPT", "METRICS_PROMPT", "schema", "overlay", "other"],
            "description": "Which file/prompt to modify"
          },
          "action": {
            "type": "string",
            "description": "Specific edit to make (e.g., 'Add X to line Y')"
          },
          "rationale": {
            "type": "string",
            "description": "Why this change should help"
          },
          "priority": {
            "type": "string",
            "enum": ["high", "medium", "low"]
          }
        }
      }
    }
  },
  "$defs": {
    "Issue": {
      "type": "object",
      "required": ["type", "severity", "description"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "TABLE_TOP_EDGE",
            "TABLE_BOTTOM_EDGE",
            "TABLE_MISSING_GROUP_HEADER",
            "TABLE_MISSING_COMMENT",
            "TABLE_INCLUDES_TOTAL",
            "TABLE_MISSING_ROWS",
            "SCOPE_OVERLAP",
            "SCOPE_MISSING_TOTAL",
            "SCOPE_WRONG_TYPE",
            "SCOPE_MISSING_HEADER",
            "TOTAL_WRONG_POSITION",
            "DIAGRAM_MISDETECTED",
            "DIAGRAM_MISSED",
            "METRICS_MISSING",
            "METRICS_WRONG_BOX",
            "BREADCRUMBS_MISSING",
            "JSON_MISMATCH",
            "PHANTOM_ELEMENT",
            "OTHER"
          ],
          "description": "Issue category"
        },
        "severity": {
          "type": "string",
          "enum": ["error", "warning", "info"],
          "description": "error = extraction wrong, warning = suboptimal, info = observation"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the issue"
        },
        "pageNumber": {
          "type": "integer",
          "description": "Page where issue was found"
        },
        "location": {
          "type": "string",
          "description": "Visual location hint (e.g., 'top-left quadrant', 'middle of page')"
        },
        "expected": {
          "type": "string",
          "description": "What should be there based on visual inspection"
        },
        "actual": {
          "type": "string",
          "description": "What was extracted (from JSON)"
        },
        "jsonPath": {
          "type": "string",
          "description": "Path in layout JSON (e.g., 'scopes[0].tables[0].box_2d')"
        }
      }
    }
  }
}
