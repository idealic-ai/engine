{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://finch.claims/schemas/refine-manifest.json",
  "title": "Refine Workload Manifest",
  "description": "Configuration for iterative prompt/schema refinement on an LLM workload",
  "type": "object",
  "required": ["workloadId", "promptPaths", "casePaths", "runCommand", "outputPath", "targetPhase", "reviewChecklist"],
  "properties": {
    "workloadId": {
      "type": "string",
      "description": "Unique identifier for this workload (e.g., 'estimate-extraction', 'invoice-parser')"
    },
    "targetPhase": {
      "type": "string",
      "enum": ["layout", "data", "annotations", "matching"],
      "description": "Which pipeline phase this refinement targets"
    },
    "reviewChecklist": {
      "type": "string",
      "description": "Path to the visual QA checklist for this phase (e.g., 'packages/estimate/docs/implementation/REVIEW_DATA.md')"
    },
    "detailLevel": {
      "type": "string",
      "enum": ["layout", "rows", "cells", "values"],
      "default": "rows",
      "description": "Overlay detail level for visual critique (layout=scopes/tables, rows=line items, cells=columns, values=all)"
    },
    "promptPaths": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "Paths to prompt files that may be modified during refinement"
    },
    "schemaPaths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Paths to schema files (Zod, JSON Schema) that may be modified during refinement"
    },
    "casePaths": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "Glob patterns for test case input files (e.g., 'cases/*/input.json', 'images/*.png')"
    },
    "expectedPaths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Glob patterns for expected output files (optional â€” visual-only mode if omitted)"
    },
    "runCommand": {
      "type": "string",
      "description": "Shell command to run extraction. Use {case} placeholder for input path."
    },
    "outputPath": {
      "type": "string",
      "description": "Path template for extraction output. Use {case} placeholder."
    },
    "overlayCommand": {
      "type": "string",
      "description": "Shell command to generate visual overlay. Use {output} and {image} placeholders."
    },
    "validationScripts": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Shell commands for custom invariant checks (e.g., 'npx tsx scripts/check-no-overlap.ts --input {output}')"
    },
    "critiquePrompt": {
      "type": "string",
      "description": "Custom prompt for Claude's visual critique phase. If omitted, uses default critique prompt."
    },
    "critiqueScript": {
      "type": "string",
      "description": "Path to custom critique script (overrides Claude critique). Script receives {output} and {overlay} paths."
    },
    "maxIterations": {
      "type": "integer",
      "minimum": 1,
      "default": 5,
      "description": "Maximum iterations for --auto mode"
    }
  },
  "additionalProperties": false
}
