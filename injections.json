[
  {
    "id": "overflow-dehydration",
    "description": "Order agent to dehydrate at overflow threshold (§CMD_DEHYDRATE is preloaded)",
    "trigger": {
      "type": "contextThreshold",
      "condition": { "gte": "OVERFLOW_THRESHOLD" }
    },
    "payload": {
      "text": "CONTEXT OVERFLOW — §CMD_DEHYDRATE NOW. Follow the §CMD_DEHYDRATE protocol preloaded in your context. Produce JSON, pipe to `engine session dehydrate sessions/[CURRENT_SESSION]`. This is your LAST action before restart."
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 1,
    "inject": "always",
    "whitelist": [
      "Bash(engine session *)",
      "Bash(engine log *)",
      "Bash(ls *)"
    ]
  },
  {
    "id": "session-gate",
    "description": "Block non-whitelisted tools when no active session (§CMD_REQUIRE_ACTIVE_SESSION)",
    "trigger": {
      "type": "lifecycle",
      "condition": { "noActiveSession": true }
    },
    "payload": {
      "text": "§CMD_REQUIRE_ACTIVE_SESSION: No active session (found: $sessionDir, lifecycle: $lifecycle). Use engine session activate to start a session, or AskUserQuestion to ask the user which skill to use. Popular: /do, /implement, /analyze, /fix, /test"
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 2,
    "inject": "always",
    "whitelist": [
      "AskUserQuestion",
      "Skill",
      "Bash(engine session *)",
      "Read(*/.claude/*)",
      "Read(*/CLAUDE.md)",
      "Read(*/memory/*)",
      "Read(*/MEMORY.md)",
      "Read(*/sessions/*.md)"
    ]
  },
  {
    "id": "idle-gate",
    "description": "Restrict tools when session is idle — only skill selection and engine commands allowed",
    "trigger": {
      "type": "lifecycle",
      "condition": { "eq": "idle" }
    },
    "payload": {
      "text": "Session is idle (synthesis complete). Pick a skill to continue, start a new session, or close. Use AskUserQuestion, Skill, or engine commands only."
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 3,
    "inject": "always",
    "whitelist": [
      "AskUserQuestion",
      "Skill",
      "Bash(engine session *)",
      "Bash(engine log *)"
    ]
  },
  {
    "id": "heartbeat-warn",
    "description": "Warn agent to log progress (§CMD_LOG_BETWEEN_TOOL_USES) at warn threshold",
    "trigger": {
      "type": "perTranscriptToolCount",
      "condition": { "eq": 3 }
    },
    "payload": {
      "text": "§CMD_LOG_BETWEEN_TOOL_USES: Tool calls without logging approaching limit. Log soon."
    },
    "mode": "inline",
    "urgency": "allow",
    "priority": 50,
    "inject": "always",
    "whitelist": [
      "Bash(engine log *)",
      "Bash(engine session *)",
      "Read(*/.claude/*)",
      "Read(*/TEMPLATE_*_LOG.md)",
      "Task",
      "Write"
    ]
  },
  {
    "id": "heartbeat-block",
    "description": "Block agent until it logs progress (§CMD_LOG_BETWEEN_TOOL_USES) at block threshold",
    "trigger": {
      "type": "perTranscriptToolCount",
      "condition": { "gte": 10 }
    },
    "payload": {
      "text": "§CMD_LOG_BETWEEN_TOOL_USES: Log progress now."
    },
    "mode": "inline",
    "urgency": "block",
    "priority": 5,
    "inject": "always",
    "whitelist": [
      "Bash(engine log *)",
      "Bash(engine session *)",
      "Read(*/.claude/*)",
      "Read(*/TEMPLATE_*_LOG.md)",
      "Task",
      "Write"
    ]
  },
  {
    "id": "directive-autoload",
    "description": "Auto-preload pending directive files when discovered (content injected alongside tool allow)",
    "trigger": {
      "type": "discovery",
      "condition": { "field": "pendingDirectives", "nonEmpty": true }
    },
    "payload": {
      "preload": "$pendingDirectives"
    },
    "mode": "preload",
    "urgency": "allow",
    "priority": 20,
    "inject": "always"
  },
  {
    "id": "template-preload",
    "description": "Auto-preload pending template files when discovered by Skill hook",
    "trigger": {
      "type": "discovery",
      "condition": { "field": "pendingTemplates", "nonEmpty": true }
    },
    "payload": {
      "preload": "$pendingTemplates"
    },
    "mode": "preload",
    "urgency": "allow",
    "priority": 21,
    "inject": "always"
  },
  {
    "id": "command-preload",
    "description": "Auto-preload pending CMD files when discovered by phase transition hook",
    "trigger": {
      "type": "discovery",
      "condition": { "field": "pendingCommands", "nonEmpty": true }
    },
    "payload": {
      "preload": "$pendingCommands"
    },
    "mode": "preload",
    "urgency": "allow",
    "priority": 22,
    "inject": "always"
  },
  {
    "id": "synthesis-commands",
    "description": "Inject synthesis protocol commands when entering synthesis phase",
    "trigger": {
      "type": "phase",
      "condition": { "matches": "Synthesis" }
    },
    "payload": {
      "text": "SYNTHESIS PHASE ACTIVE: Execute §CMD_RUN_SYNTHESIS_PIPELINE. Sub-phases: Checklists → Debrief → Pipeline → Close. Each sub-phase requires proof before proceeding."
    },
    "mode": "inline",
    "urgency": "allow",
    "priority": 30,
    "inject": "once"
  }
]
